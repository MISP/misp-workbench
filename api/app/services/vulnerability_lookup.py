import requests

VulnerabilityLookupClient = requests.Session()

def lookup(vuln_id: str) -> dict:
    vuln_data = VulnerabilityLookupClient.get(f"https://vulnerability.circl.lu/api/vulnerability/{vuln_id}?with_meta=false&with_linked=false&with_comments=false&with_bundles=false&with_sightings=false").json()

    if vuln_data is None:
        return {"error": "Vulnerability not found"}

    return parse_vulnerability_data(vuln_data)


def parse_vulnerability_data(vuln_data: dict) -> dict:
    if "error" in vuln_data:
        return vuln_data

    cna = vuln_data.get("containers", {}).get("cna", {})
    description = ""
    severity = None
    references = []

    # Extract description
    descriptions = cna.get("descriptions", [])
    for desc in descriptions:
        if desc.get("lang") == "en":
            description = desc.get("value", "")
            break

    # Extract severity from CVSS metrics
    metrics = cna.get("metrics", [])
    for metric in metrics:
        cvss = metric.get("cvssV3_1")
        if cvss:
            severity = cvss.get("baseSeverity")
            break

    # Extract references
    refs = cna.get("references", [])
    for ref in refs:
        references.append(ref.get("url"))

    # Extract impacted products
    impacted_products = cna.get("affected", [])

    return {
        "description": description,
        "severity": severity,
        "references": references,
        "impacted_products": impacted_products,
    }
